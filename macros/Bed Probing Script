G10 P0 R290 S290

; Homing XYU axis if they are not homed
if !move.axes[0].homed || !move.axes[1].homed || !move.axes[2].homed || !move.axes[3].homed
  M98 P"homeall.g"
else
  ;M98 P"homez.g"


M116 P0 S5
M83            ; relative extruder moves
G1 E-5 F{60}*{50}  ; retract 10mm of filament
T-1
T0


G90
G1 F18000 X0 Z15 Y-100
M290 R0 S0

M42 P4 S1    ; Turn on relay, engage probing (ESD Warning)
G4 S0.5
M208 Z-10 S1         ; set axis minima



G38.4 K0 Z{move.axes[2].min}


G91
G1 F18000 Z5
G90

G38.4 K0 Z{move.axes[2].min} Y150
M42 P4 S0    ; Turn of relay

var xx = move.axes[0].userPosition
var yy = move.axes[1].userPosition
var zn = move.axes[2].userPosition

G91
G1 Z20
G90



M98 R P"essential/attachedcheck.g" ; make sure probe is conected, pick if negative and leave relay active
G90                 ; absolute positioning
G1 X{var.xx - sensors.probes[0].offsets[0]} Y{var.yy - sensors.probes[0].offsets[1]} F18000
M558 K0 P5 C"duex.e6stop" H5 F300 T18000
M98 P"essential/autogen/ProbeOffset.g"
G38.2 K0 Z{move.axes[2].min}
var zp = move.axes[2].userPosition
var dd = var.zp - var.zn
echo var.dd

set global.zoffset = var.dd - {0.1}  ; Apply babystepping to zoffset
echo >"essential/autogen/ProbeOffset.g" "; THIS FILE IS AUTOGENERATED !" ; Generate ProbeOffset.g
echo >>"essential/autogen/ProbeOffset.g" "; Please edit contents of '/macros/Save Z offset'"
echo >>"essential/autogen/ProbeOffset.g" "; Set Z probe trigger value, offset and trigger height"
echo >>"essential/autogen/ProbeOffset.g" "G31 P500 X0 Y28.50"
echo >>"essential/autogen/ProbeOffset.g" "G31 Z"^{global.zoffset}
echo >>"essential/autogen/ProbeOffset.g" ""
echo >>"essential/autogen/ProbeOffset.g" ";When too Low => Subtract the difference"
echo >>"essential/autogen/ProbeOffset.g" ";When too High => Add the difference"
echo >"essential/autogen/zoffset.g" "; THIS FILE IS AUTOGENERATED !"  ; Generate zoffset.g (persistent zoffset var)
echo >>"essential/autogen/zoffset.g" "; Please edit contents of '/macros/Save Z offset'"
echo >>"essential/autogen/zoffset.g" "if exists(global.zoffset)"
echo >>"essential/autogen/zoffset.g" "  set global.zoffset = "^{global.zoffset}
echo >>"essential/autogen/zoffset.g" "else"
echo >>"essential/autogen/zoffset.g" "  global zoffset = "^{global.zoffset}; Reset babystepping to 0 to avoid accidentally adding offset second time



G91
G1 Z10
G90
M98 P"place.g"



M208 Z0 S1         ; set axis minima
;G10 P0 R0 S0