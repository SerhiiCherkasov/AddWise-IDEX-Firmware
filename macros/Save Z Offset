; Save offset only if machine doesn't do anything

if {state.status == "processing" || state.status == "pausing" || state.status == "paused" || state.status == "resuming"}
  M291 R"This option is not available when machine is busy" P"Please wait for printer to finish" S1
else
  set global.zoffset = global.zoffset - move.axes[2].babystep  ; Apply babystepping to zoffset
  echo >"0:/user/ProbeOffset.g" "; THIS FILE IS AUTOGENERATED !" ; Generate ProbeOffset.g
  echo >>"0:/user/ProbeOffset.g" "; Please edit contents of '/macros/Save Z offset'"
  echo >>"0:/user/ProbeOffset.g" "; Set Z probe trigger value, offset and trigger height"
  echo >>"0:/user/ProbeOffset.g" "G31 P500 X19.50 Y-23.00 Z"^{global.zoffset}
  echo >>"0:/user/ProbeOffset.g" ""
  echo >>"0:/user/ProbeOffset.g" ";When too Low => Subtract the difference"
  echo >>"0:/user/ProbeOffset.g" ";When too High => Add the difference"
  echo >"0:/user/zoffset.g" "; THIS FILE IS AUTOGENERATED !"  ; Generate zoffset.g (persistent zoffset var)
  echo >>"0:/user/zoffset.g" "; Please edit contents of '/macros/Save Z offset'"
  echo >>"0:/user/zoffset.g" "if exists(global.zoffset)"
  echo >>"0:/user/zoffset.g" "  set global.zoffset = "^{global.zoffset}
  echo >>"0:/user/zoffset.g" "else"
  echo >>"0:/user/zoffset.g" "  global zoffset = "^{global.zoffset}; Reset babystepping to 0 to avoid accidentally adding offset second time
  M290 R0 S0
  M98 P"0:/user/ProbeOffset.g"

