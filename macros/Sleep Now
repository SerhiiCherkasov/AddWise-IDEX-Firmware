M291 R"Do you want to go to sleep mode now?" P" " S1

if {state.status == "processing" || state.status == "pausing" || state.status == "paused" || state.status == "resuming"}
  M291 R"Machine will turn off after the print is finished" P" " S1
  M98 P"0:/macros/System/Settings/Job End Machine Behaviour/Bed Position/Lower the bed after print is finished"
  M81 S1
else
  if !move.axes[0].homed || !move.axes[1].homed || !move.axes[2].homed || !move.axes[3].homed
    M98 P"homeall.g"
  
  M98 P"0:/macros/System/Settings/Job End Machine Behaviour/Bed Position/Lower the bed after print is finished"
  M98 P"essential/autogen/lowerbed.g"               ; lower the bed (if needed)
  M98 P"essential/autogen/bedfinishbehavior.g"	    ; decide what to do with bed after printing is finished
  M98 P"essential/autogen/chamberfinishbehavior.g"	; decide what to do with chamber after printing is finished
  
  G1 Y160 F18000
  
  ; Disable Fans
  M106 P5 S0
  M106 P3 S0
  M106 P1 S0
  
  ;Cool Down Tools
  G10 P0 S0 R0
  G10 P1 S0 R0
  G10 P2 S0 R0
  G10 P3 S0 R0
  
  M84 XYU
  M81 S1