; Prompt the user to select a tool
M291 S4 K{"T0 - Left Tool","T1 - Right Tool","Cancel"} R"Select a Tool" P"Choose the Left Tool (T0) or Right Tool (T1). Select ""Cancel"" to exit."

if input != 0 && input != 1
    abort "Canceled"                           ; Abort the macro if the user selects 'Cancel'

var tool = input


; Prompt the user to set the material print temperature
M291 S5 J1 F250 L150 H450 R"Set Material Print Temperature" P"Enter the temperature for the filament last used in the selected tool."

var temp = input                                               ; Store the user input in the 'temp' variable
var temp_pull = var.temp / 2                                   ; Calculate 'temp_pull'
var temp_stop = {var.temp + var.temp_pull}/2*0.9               ; Calculate 'temp_stop'

M568 P{var.tool} A2                                            ; Set the active tool to the selected tool
G10  P{var.tool} R{var.temp} S{var.temp}                       ; Set the tool temperature to 'temp'

; Check if any of the axes are not homed, and home all if necessary
if !move.axes[0].homed || !move.axes[1].homed || !move.axes[2].homed || !move.axes[3].homed
    M98 P"0:/sys/homeall.g" S1

M116 P{var.tool} S5                                            ; Wait for the tool to reach the set temperature
T-1                                                            ; Deselect any active tool
T T{var.tool}                                                  ; Select the tool based on the 'tool' variable


M302 P1                                                        ; Allow cold extrusion
M83                                                            ; Relative extruder moves
G1 E50 F{5 * 60}                                               ; Extrude filament
M400

; lower the temp below cold pull temp
G10  P{var.tool} R{var.temp_pull * 0.8} S{var.temp_pull * 0.8} ; Set the tool temperature to 'temp_pull'

M106 S1

; Extrude while lowering the temperature
while sensors.analog[{var.tool}].lastReading > {var.temp_stop + var.temp}/2
    M400    
    G1 E1 F{3 * 60}                                            ; Extrude filament

; Extrude slowly while lowering the temperature
while sensors.analog[{var.tool}].lastReading > var.temp_stop
    M400    
    G1 E1 F{1 * 60}                                            ; Extrude filament



M116 P{var.tool} S10                                           ; Wait for the tool to reach the set temperature

; set cold pull temp and wait
G10  P{var.tool} R{var.temp_pull} S{var.temp_pull}
M116 P{var.tool} S5                                            ; Wait for the tool to reach the set temperature

G10  P{var.tool} R{var.temp_stop} S{var.temp_stop}             ; Set the tool temperature

while sensors.analog[{var.tool}].lastReading < {var.temp_stop + var.temp_pull}/2
    M400    
    G1 E-1 F{1 * 60}                                           ; Extrude filament
    G4 P200

G1 E-20 F{5 * 60}                                              ; Extrude filament
M400
G1 E-100 F{15 * 60}                                            ; Extrude filament
M400


M302 P0                                                        ; Disallow cold extrusion
G10  P{var.tool} R{0} S{0}                                     ; Set the tool temperature to 'temp'